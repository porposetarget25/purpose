<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Travel & Safety | World Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preload" href="assets/css/styles.css" as="style" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0a3d62">

    <style>
        /* Keep ‚ÄúTravel & Safety‚Äù in one line in the top nav */
        .topbar .nav__link { white-space: nowrap; }

        /* Small page-specific polish */
        .ts-hero { position: relative; overflow: hidden; border-radius: 20px; margin: 20px auto; }
        .ts-hero .hero__media { filter: brightness(0.85) saturate(110%); }
        .ts-wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
        .ts-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0 20px; }
        .ts-select { appearance:none; padding:12px 16px; border-radius:14px; border:1px solid #e6e9f0; background:#fff; font-weight:600 }
        .ts-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(6px);
                   border: 1px solid #eef1f6; border-radius: 16px; padding: 18px; margin: 12px 0; }
        .ts-card h3 { margin: 0 0 8px; font-size: 1.05rem; }
        .ts-muted { color:#6b7280; font-size: .9rem; }
        .ts-badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef5ff; color:#1d4ed8; font-weight:600; font-size:.8rem; }
        .ts-note { background:#fff8d8; border:1px solid #f2e7a8; color:#6b5f02; padding:10px 12px; border-radius:12px; font-size:.9rem; }
        .ts-list { margin:0; padding-left: 18px; }
        .ts-list li { margin: 6px 0; }
        .ts-kv { display:grid; grid-template-columns: 140px 1fr; gap:8px 14px; }
        .ts-kv b { color:#374151; }
        @media (max-width: 860px) { .ts-wrap { padding: 12px; } .ts-kv { grid-template-columns: 120px 1fr; } }
    </style>
</head>

<body>
<!-- Topbar -->
<nav class="topbar">
    <div class="topbar__inner container">
        <a class="brand" href="index.html" aria-label="World Explorer Home">
            <span class="brand__logo globe">üåê</span>
            <span class="brand__text">
        <strong>World Explorer</strong>
        <small>Explore the World's Wonders</small>
      </span>
        </a>
        <ul class="nav">
            <li><a class="nav__link" href="index.html">Home</a></li>
            <li><a class="nav__link is-active" href="travel.html">Travel &amp; Safety</a></li>
        </ul>
    </div>
</nav>

<!-- Hero -->
<header class="hero ts-hero"
        style="--hero-photo: url('https://images.unsplash.com/photo-1534854638093-bada1813ca19?q=80&w=1600&auto=format&fit=crop')">
    <div class="hero__media" aria-hidden="true"></div>
    <div class="hero__overlay"></div>
    <div class="hero__content container">
        <h1 class="hero__title">Travel &amp; Safety</h1>
        <p class="hero__tagline">Quick essentials for a safer, smoother trip. Policies change often‚Äîalways verify with official sources.</p>
    </div>
</header>

<main class="ts-wrap">
    <!-- Controls -->
    <div class="ts-controls">
        <span class="ts-badge">Select a country</span>
        <select id="country-select" class="ts-select" aria-label="Select a country"></select>
        <span class="ts-muted">Tip: this is a helpful summary, not legal advice. Always double-check with official sources.</span>
    </div>

    <!-- Output cards -->
    <section id="ts-output"></section>
</main>
<script>
    /* =========================
       Travel & Safety (AI + fallback)
       ========================= */
    const selectEl = document.getElementById('country-select');
    const out = document.getElementById('ts-output');

    /* Countries (ISO alpha-2) */
    const COUNTRIES = [
      { code: "TR", name: "Turkey" },
      { code: "IN", name: "India" },
      { code: "AE", name: "UAE" },
      { code: "ZA", name: "South Africa" },
      { code: "US", name: "USA" },
      { code: "GB", name: "United Kingdom" },
      { code: "NZ", name: "New Zealand" },
      { code: "JP", name: "Japan" },
      { code: "SG", name: "Singapore" },
      { code: "FR", name: "France" },
      { code: "IT", name: "Italy" },
      { code: "ES", name: "Spain" },
      { code: "AU", name: "Australia" },
      { code: "CA", name: "Canada" }
    ];

    /* Emergency numbers (fallback) */
    const EMERGENCY = {
      TR: { police: "155", ambulance: "112", fire: "110" },
      IN: { police: "112", ambulance: "108", fire: "101" },
      AE: { police: "999", ambulance: "998", fire: "997" },
      US: { police: "911", ambulance: "911", fire: "911" },
      GB: { police: "999 / 112", ambulance: "999 / 112", fire: "999 / 112" },
      NZ: { police: "111", ambulance: "111", fire: "111" },
      JP: { police: "110", ambulance: "119", fire: "119" },
      SG: { police: "999", ambulance: "995", fire: "995" },
      FR: { police: "17", ambulance: "15 (SAMU)", fire: "18" },
      IT: { police: "112", ambulance: "118", fire: "115" },
      ES: { police: "112", ambulance: "112", fire: "112" },
      AU: { police: "000", ambulance: "000", fire: "000" },
      CA: { police: "911", ambulance: "911", fire: "911" },
      ZA: { police: "10111", ambulance: "10177", fire: "10177" }
    };

    /* ---- Small helpers ---- */
    const TTL_MS = 24 * 60 * 60 * 1000;
    const ckWorker = (code) => `ts:worker:${code}`;
    const ckSummary = (code) => `ts:summary:${code}`;

    function getCached(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (Date.now() - obj.saved > TTL_MS) return null;
        return obj.data;
      } catch { return null; }
    }
    function setCached(key, data) {
      try { localStorage.setItem(key, JSON.stringify({ saved: Date.now(), data })); } catch {}
    }

    function sectionTpl(title, items) {
      const list = (items || []).map(i => `<li>${i}</li>`).join("");
      return `<article class="ts-card"><h3>${title}</h3><ul class="ts-list">${list}</ul></article>`;
    }

    function renderLoading(label) {
      out.innerHTML = `<article class="ts-card">Loading travel & safety info for <strong>${label}</strong>‚Ä¶</article>`;
    }
    function renderError(label, msg) {
      out.innerHTML = `<article class="ts-card ts-note">Couldn‚Äôt load info for <strong>${label}</strong>. ${msg || "Please try again."}</article>`;
    }

    /* =========================
       DATA FETCHERS
       ========================= */

    // 1) Preferred: your Cloudflare Worker (returns { country, code, updated_at, basics, advice })
    async function fetchFromWorker(code) {
      const key = ckWorker(code);
      const cached = getCached(key);
      if (cached) return cached;

      const url = `https://purpose.porpose-target-25.workers.dev/api/travel-safety?country=${encodeURIComponent(code)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Worker HTTP ${res.status}`);
      const json = await res.json(); // {country, code, updated_at, basics, advice?}
      setCached(key, json);
      return json;
    }

    // 2) Fallback: RestCountries for quick facts if Worker fails
    async function fetchCountrySummary(code) {
      const key = ckSummary(code);
      const cached = getCached(key);
      if (cached) return cached;

      const url = `https://restcountries.com/v3.1/alpha/${encodeURIComponent(code)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`RestCountries HTTP ${res.status}`);
      const [c] = await res.json();

      const data = {
        officialName: c?.name?.official || "‚Äî",
        capital: (c?.capital && c.capital[0]) || "‚Äî",
        region: c?.region || "‚Äî",
        subregion: c?.subregion || "",
        languages: c?.languages ? Object.values(c.languages).join(", ") : "‚Äî",
        currency: c?.currencies ? Object.keys(c.currencies)[0] : "‚Äî",
        callingCode:
          c?.idd?.root
            ? c.idd.root + ((c.idd.suffixes && c.idd.suffixes[0]) || "")
            : "‚Äî"
      };
      setCached(key, data);
      return data;
    }

    /* =========================
       RENDER
       ========================= */

    function renderCountryData(label, basics, code, advice, updated_at) {
      const updatedLocal = new Date(updated_at || Date.now()).toLocaleString();

      const quick = `
        <article class="ts-card">
          <div class="ts-kv">
            <b>Official</b><span>${basics.officialName}</span>
            <b>Capital</b><span>${basics.capital}</span>
            <b>Region</b><span>${basics.region}${basics.subregion ? " ‚Äî " + basics.subregion : ""}</span>
            <b>Languages</b><span>${basics.languages}</span>
            <b>Currency</b><span>${basics.currency}</span>
            <b>Dial code</b><span>${basics.callingCode}</span>
          </div>
        </article>`;

      // advice.* from Worker OR fallbacks
      const visa   = advice?.visa   ?? [
        `Passport validity: aim for <b>6+ months</b> beyond arrival.`,
        `Check official visa policy for ${label} (government/embassy).`,
        `Onward ticket & proof of funds may be required.`,
        `Travel insurance is strongly recommended.`
      ];
      const laws   = advice?.laws   ?? [
        `Respect local laws and customs; penalties can be severe.`,
        `Alcohol rules vary by place and age.`,
        `Avoid photographing military/government sites.`,
        `Drones often need permits.`
      ];
      const safety = advice?.safety ?? [
        `Stick to well-lit, busy areas; secure valuables.`,
        `Use licensed taxis or reputable ride-hailing.`,
        `Beware of common scams in tourist spots.`,
        `Keep copies of passport/visa/insurance.`
      ];
      const health = advice?.health ?? [
        `Review vaccine guidance (CDC / TravelHealthPro).`,
        `Drink treated/bottled water where tap isn‚Äôt potable.`,
        `Carry prescriptions in original packaging.`,
        `Know nearby hospitals/clinics.`
      ];

      // emergency_numbers from advice, else map fallback
      const en = advice?.emergency_numbers;
      const fallback = EMERGENCY[code] || {};
      const emergencyList = [
        `Police: <b>${(en && en.police) || fallback.police || "Check locally"}</b>`,
        `Ambulance: <b>${(en && en.ambulance) || fallback.ambulance || "Check locally"}</b>`,
        `Fire: <b>${(en && en.fire) || fallback.fire || "Check locally"}</b>`,
        ...((en && Array.isArray(en.notes)) ? en.notes : [])
      ];

      const aiBadge = advice ? `<span class="ts-badge" title="Generated by AI">AI-generated</span>` : `<span class="ts-badge" title="Fallback guidance">Fallback</span>`;

      const disclaimer = `
        <article class="ts-card ts-note">
          Source: ${advice ? 'AI (via Worker)' : 'local fallback'} ${aiBadge}
          ‚Ä¢ Updated: ${updatedLocal}. Always verify with official sources.
        </article>`;

      out.innerHTML = `
        <div class="ts-muted" style="margin:6px 0">${label}</div>
        ${quick}
        ${sectionTpl("1) Visa & Entry Requirements", visa)}
        ${sectionTpl("2) Local Laws & Rules", laws)}
        ${sectionTpl("3) Safety & Security", safety)}
        ${sectionTpl("4) Emergency Numbers", emergencyList)}
        ${sectionTpl("5) Health Precautions", health)}
        ${disclaimer}
      `;
    }

    /* =========================
       UI WIRING
       ========================= */

    function populateSelect() {
      selectEl.innerHTML = COUNTRIES
        .map(c => `<option value="${c.code}">${c.name}</option>`)
        .join("");
    }

    async function showCountryByCode(code) {
      const label = COUNTRIES.find(c => c.code === code)?.name || code;
      renderLoading(label);
      try {
        // Prefer Worker (gives both basics + advice). If Worker fails, fall back to RestCountries.
        let payload;
        try {
          payload = await fetchFromWorker(code); // {country, code, updated_at, basics, advice?}
        } catch {
          payload = null;
        }

        if (payload?.basics) {
          renderCountryData(label, payload.basics, code, payload.advice || null, payload.updated_at);
        } else {
          // Worker failed: fetch basics only, no AI advice
          const basics = await fetchCountrySummary(code);
          renderCountryData(label, basics, code, null, null);
        }
      } catch (err) {
        console.error(err);
        renderError(label, "Check your connection or try again later.");
      }
    }

    // Init
    populateSelect();
    showCountryByCode(COUNTRIES[0].code);
    selectEl.addEventListener("change", () => showCountryByCode(selectEl.value));
</script>

</body>
</html>
